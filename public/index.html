<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Realtime TÃ¼rkÃ§e KonuÅŸan Bot</title>
</head>
<body>
  <h1>ğŸ¤ TÃ¼rkÃ§e KonuÅŸan AI Bot</h1>
  <button id="start-btn">KonuÅŸmayÄ± BaÅŸlat</button>
  <button id="reply-btn">Cevap Al</button>
  <audio id="remoteAudio" autoplay controls></audio>

  <script>
    let pc, dc;

    async function start() {
      const tokenRes = await fetch("/session");
      const data = await tokenRes.json();
      const EPHEMERAL_KEY = data.client_secret?.value;

      if (!EPHEMERAL_KEY) {
        console.error("Ephemeral key alÄ±namadÄ±:", data);
        return alert("Ephemeral key alÄ±namadÄ±. Konsola bakÄ±n.");
      }

      pc = new RTCPeerConnection();

      const audioEl = document.getElementById("remoteAudio");
      pc.ontrack = (e) => {
        audioEl.srcObject = e.streams[0];
      };

      const ms = await navigator.mediaDevices.getUserMedia({ audio: true });
      pc.addTrack(ms.getTracks()[0]);

      dc = pc.createDataChannel("oai-events");
      dc.addEventListener("message", (e) => console.log("Event:", e.data));

      dc.addEventListener("open", () => {
        console.log("âœ… DataChannel aÃ§Ä±k.");

        const updateSessionEvent = {
          type: "session.update",
          session: {
            instructions: "Sen bir TÃ¼rkÃ§e konuÅŸan asistanÄ±sÄ±n. TÃ¼m cevaplarÄ±nÄ± TÃ¼rkÃ§e ver.",
            turn_detection: {
              type: "server_vad",
              create_response: false,
              interrupt_response: false
            },
          },
        };
        dc.send(JSON.stringify(updateSessionEvent));
        console.log("ğŸ“¤ Session update gÃ¶nderildi.");
      });

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      const resp = await fetch(`https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview-2024-12-17`, {
        method: "POST",
        body: offer.sdp,
        headers: {
          Authorization: `Bearer ${EPHEMERAL_KEY}`,
          "Content-Type": "application/sdp",
        },
      });

      const answer = { type: "answer", sdp: await resp.text() };
      await pc.setRemoteDescription(answer);

      console.log("ğŸ¤ KonuÅŸmaya hazÄ±rsÄ±n!");
    }

    function triggerResponse() {
      if (!dc || dc.readyState !== "open") {
        return alert("DataChannel aÃ§Ä±k deÄŸil!");
      }

      const event = {
        type: "response.create",
        response: { modalities: ["audio", "text"] },
      };
      dc.send(JSON.stringify(event));
      console.log("ğŸ“¤ response.create gÃ¶nderildi.");
    }

    document.getElementById("start-btn").addEventListener("click", start);
    document.getElementById("reply-btn").addEventListener("click", triggerResponse);
  </script>
</body>
</html>
